# 이미지 검색 기반 추천 시스템

> Perceptual Hash와 LSH 기법을 사용한 유사 이미지 검색 및 상품 추천 시스템 <br>
> 개발기간 : 2024.10 ~ 2024.12

<br>

## 프로젝트 요약

본 프로젝트에서는 생성형 AI의 산출물을 상업적 목적으로 활용하고자, 내용 기반 이미지 검색(Content-Based Image Retrieval, CBIR) 기술을 활용하여 사용자가 제공한 질의 이미지와 유사한 이미지를 추천하는 기법을 제안한다. <br> 
- 이미지 간의 세밀한 차이를 감지할 수 있도록 pHash의 구조를 개선
- 개선한 pHash와 Color Thief 라이브러리를 활용하여 이미지의 고유 정보를 추출후 저장
- LSH 알고리즘을 통해 질의 이미지의 해시값과 일부 일치하는 상품을 선별한 다음, <br>해밍 거리(Hamming Distance)와 자카드 유사도를 사용하여 최종 추천 상품 목록을 반환

사용한 기술 스택
- node.js
- Express
- AWS S3
- MySQL

성능
- 유사 이미지 검색 정확도(상위 10개 이미지 기준) : 47.3%
- 검색 속도 : 평균 569ms
  
<br>

## 화면 구성

|![화면 캡처 2024-12-06 011048](https://github.com/user-attachments/assets/784b5681-99e9-4355-b1d9-e138b6e9c124)|![화면 캡처 2025-01-10 203430](https://github.com/user-attachments/assets/7c99d076-168e-42ca-9db8-ea18e2ccf166)|![화면 캡처 2025-01-10 203536](https://github.com/user-attachments/assets/9dfb330d-23a6-46a5-899f-187869d0877c)|
|:---:|:---:|:---:|
|질의 이미지 입력 페이지|상품 상세 페이지|이미지 검색 페이지|

<br>

## 사용한 기술 스택 

| 구분 | 버전 |
|:---:|:---:|
|  Software | node: 20.17.0 <br> express 4.21.1 <br>  aws-sdk/client-s3 3.697.0 <br>  color-thief 2.3.0  |
| DBMS |  mariadb 11.2 |

<br>

## 주요 기능

### 주요 기능 요약

|![1](https://github.com/user-attachments/assets/ec15f239-ec75-4d4d-918d-10358215722d)|
|:---:|
|주요 로직 아키텍쳐|

1. 사용자 친화적인 GUI를 이용한 이미지 검색
   - AI가 생성한 이미지를 업로드하거나, 사용자가 직접 그린 그림을 질의어로 사용
2. 이미지 패턴 추출 및 색상 정보 추출
   - pHash와 ColorThief 라이브러리를 이용한 특징 추출
3. LSH를 이용한 이미지 검색
   - 추출한 이미지 특징을 바탕으로 유사한 이미지 후보군을 빠르게 선별 후 유사도 비교

### 이미지 패턴 및 색상 특징 추출

이미지 패턴 추출
- 성능을 개선한 pHash를 이용하여 이미지 패턴 추출
- 64x64로 리사이즈한 이미지를 바탕으로 4배 더 많은 세부 정보를 담은 256비트 해시 값을 산출

이미지 색상 추출
- Color Thief 라이브러리를 이용하여 색상 추출 후 15개의 색상 카테고리로 분류
- 추출한 RGB 값을 3차원 좌표로 변환한 다음 색상간 유사성을 거리로 계산
- 15개의 색상 카테고리 : Red, Orange, Yellow, Lime, Green, Turquoise, Cyan, 
Ocean, Blue, Violet, Magenta, aspberry, Black, White, Gray

### 유사한 이미지 탐색

LSH을 이용하여 데이터를 분산 저장
- LSH는 비슷한 항목을 동일한 버킷에 할당하는 해시 알고리즘
- 슬라이딩 윈도우 기법을 통해 이미지 해시 값을 일부 겹치게 4자리씩 분할
- 분할한 해시 값을 버킷 키로 사용하여, 유사한 데이터를 동일한 버킷에 저장

유사 이미지 검색 과정
1. 질의 이미지 해시 값과 일부 일치하는 LSH 버킷에 저장된 후보 이미지 선별
2. 질의 데이터와 후보 이미지 간 해밍 거리를 계산하여 1차 유사도 산출
3. 질의 데이터와 후보 이미지의 색상 정보 간 자카드 유사도를 측정
4. 측정한 자카드 유사도를 바탕으로 가중치를 부여하여 최종 유사도 산출

<br>



## 성능 평가

### 성능 평가 방법
- 총 1800건의 이미지 데이터를 대상으로 임의로 이미지 15건을 선정하여 실험을 진행
- 사용한 데이터 : AI 허브에서 제공하는 ‘상품 이미지’ 데이터 셋 1800건 (음료, 과자, 디저트, 면류 등 편의점 상품 데이터)

### 성능 평가 기준
- 유사 이미지 검색 정확도 = 유사도 기준으로 정렬한 상위 10개 상품 중 질의 이미지와 시각적으로 유사한 상품 종류의 수
- 이미지 검색 속도 = 15번의 측정 결과의 평균값

### 성능 평가 대상 
1. 기본 phash + 완전 탐색 조합
2. 개선된 phash + 완전 탐색 조합
3. 개선된 phash + LSH 조합

(완전 탐색의 경우, Promise 객체를 사용하여 비동기 처리)

### 측정 결과 요약
![화면 캡처 2024-12-22 235617](https://github.com/user-attachments/assets/b42ab313-4e99-4cc9-b23a-ea9883e305d7)

> 개선된 pHash와 LSH 조합은 빠른 검색 속도와 높은 검색 정확도를 제공하는 유의미한 성능을 보여주었다.

유사 이미지 검색 정확도
- 개선된 pHash를 사용하는 조합은 대부분 질의 이미지와 유사한 형태의 상품 리스트를 반환하였으며, 다른 각도로 촬영된 상품 이미지도 찾아낸 경우를 확인할 수 있었다.
- LSH를 사용한 검색 정확도는 47.3%로, 완전 탐색을 사용한 검색 정확도와 거의 유사한 수준이다.

이미지 검색 속도 결과 분석
- 개선된 pHash + LSH 조합은 효율적인 검색 구조를 통해 검색 속도를 크게 향상되었다<BR>
- 반면, 개선된 pHash + 완전 탐색 조합은 완전 탐색 방식의 비효율성과 추가 연산 복잡도로 인해 가장 느린 속도를 기록하였다.

### 성능 평가 결과 시각화
|![21](https://github.com/user-attachments/assets/c15efcf5-e735-4810-85a9-97ad1f8fcf72)| ![화면 캡처 2024-12-05 193709](https://github.com/user-attachments/assets/a4f55d0b-429c-41d5-a481-11ea4f95d540)|
|:---:|:---:|
|질의 이미지 예시|1. 기존 pHash + 완전 탐색 조합 검색 결과|
|![화면 캡처 2024-12-05 193726](https://github.com/user-attachments/assets/3d76eec9-6e42-4940-925f-e3d6bc230bbd)| ![슬라이딩 윈도우](https://github.com/user-attachments/assets/189f8d08-fdb1-4672-bfcd-0994967d53e8)|
|2. 개선된 pHash + 완전 탐색 조합 검색 결과|3. 개선된 pHash + LSH 조합 검색 결과|

> 올바른 카테고리로 분류된 이미지는 파란색 'O', 잘못된 결과 이미지는 빨간색 'X '로 표시되었으며, 나열된 순서는 유사도 순위를 반영한다.

